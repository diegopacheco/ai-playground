---
phase: 06-session-statistics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [js/stats.js, js/main.js, js/render.js]
autonomous: true

must_haves:
  truths:
    - "Player sees live score, lines, level, time, and pieces count in sidebar"
    - "Timer continues during freeze cycles"
    - "Stats reset when game restarts"
  artifacts:
    - path: "js/stats.js"
      provides: "Stats tracking module with start, update, reset methods"
      min_lines: 30
      exports: ["stats", "startSession", "updatePiecePlaced", "getSessionTime"]
    - path: "js/main.js"
      provides: "Stats integration in game loop and events"
      contains: "updatePiecePlaced"
    - path: "js/render.js"
      provides: "Sidebar stats rendering"
      contains: "drawSessionStats"
  key_links:
    - from: "js/main.js"
      to: "js/stats.js"
      via: "startSession on game init, updatePiecePlaced on piece lock"
      pattern: "startSession|updatePiecePlaced"
    - from: "js/render.js"
      to: "js/stats.js"
      via: "reads stats object for display"
      pattern: "stats\\.(score|lines|level)"
---

<objective>
Track and display basic session statistics in real-time during gameplay.

Purpose: Players need immediate feedback on their performance. Basic stats (score, lines, level, time, pieces placed) are fundamental to understanding how well they're playing.

Output: Stats tracking module and live sidebar display showing 5 core metrics.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@js/main.js
@js/render.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stats tracking module</name>
  <files>js/stats.js</files>
  <action>
Create js/stats.js with session statistics tracking. Use performance.now() for accurate timing (not timestamps from requestAnimationFrame, which pause during freeze). Track 5 basic stats:
- score (from main.js score variable)
- lines (cleared lines count)
- level (from main.js level variable)
- time (elapsed session time in milliseconds, continues during freeze)
- piecesPlaced (counter incremented on each piece lock)

Module structure:
- stats object with { score, lines, level, time, piecesPlaced, sessionStartTime }
- startSession() function initializes stats and records performance.now()
- updatePiecePlaced() function increments piecesPlaced counter
- getSessionTime() function returns elapsed milliseconds (performance.now() - sessionStartTime)
- formatTime(ms) helper returns MM:SS format string

Export stats object and functions for use in main.js and render.js.

Why performance.now() not timestamp: The game loop timestamp pauses during tab inactivity, but performance.now() continues, giving accurate session duration.
  </action>
  <verify>
cat js/stats.js | grep -E 'startSession|updatePiecePlaced|getSessionTime|formatTime'
node -e "const m = require('./js/stats.js'); console.log(typeof m.startSession)"
  </verify>
  <done>js/stats.js exists with stats object, startSession, updatePiecePlaced, getSessionTime, formatTime functions exported</done>
</task>

<task type="auto">
  <name>Task 2: Integrate stats into game loop</name>
  <files>js/main.js</files>
  <action>
Integrate stats tracking into main.js at key game events:

1. Add script tag in index.html before main.js: &lt;script src="js/stats.js"&gt;&lt;/script&gt;

2. In main.js:
   - Call startSession() in resetGame() after initializing game state
   - Call startSession() in DOMContentLoaded after initial spawnPiece()
   - Call updatePiecePlaced() in lockPieceToBoard() before spawning next piece
   - Update stats.score = score in checkLevelUp() after score changes
   - Update stats.lines in lockPieceToBoard() after clearLines
   - Update stats.level = level in checkLevelUp() after level changes

3. Stats tracking must work correctly during freeze cycles:
   - Time continues (getSessionTime() uses performance.now())
   - Piece placement pauses (updatePiecePlaced only called when not frozen)

No special handling needed for freeze state; existing game flow prevents piece locks during freeze.
  </action>
  <verify>
grep -n "startSession\|updatePiecePlaced" js/main.js
grep -n "stats\\.score\|stats\\.lines\|stats\\.level" js/main.js
  </verify>
  <done>Stats tracking integrated: startSession called on game start, updatePiecePlaced called on piece lock, stats object updated on score/lines/level changes</done>
</task>

<task type="auto">
  <name>Task 3: Display stats in sidebar</name>
  <files>js/render.js</files>
  <action>
Add real-time stats display in sidebar. Create drawSessionStats() function called from render().

Position below existing HOLD preview (currently at y=185, box height=100, so stats start at y=320):
Wait, existing drawScore uses y=320 for "SCORE" label. Stats need to go above SCORE, between HOLD and SCORE.

Revised positioning:
- HOLD ends at y=285 (185 + 100)
- Stats section: y=295 to y=315 (20px height, compact)

Stats display format:
- Single line: "TIME: 02:45"
- Single line: "PIECES: 123"
- Keep existing SCORE and LEVEL at y=320 and y=400

Function signature: drawSessionStats(sidebarX, centerX)

Stats to display:
- Lines: Use existing clearLines result counter (add to stats.lines)
- Time: Call formatTime(getSessionTime())
- Pieces: stats.piecesPlaced

Font: 'bold 12px Arial', white color (#ffffff)
Left-align at sidebarX + 10 for compact display

Draw order in render():
1. drawSidebar(board)
2. drawSessionStats(...) [NEW]
3. drawScore(score, level) [EXISTING]
4. drawNextPreview(nextPiece)
5. drawHoldPreview(heldPiece, canHold)
  </action>
  <verify>
grep -n "drawSessionStats" js/render.js
grep -n "TIME:\|PIECES:\|LINES:" js/render.js
  </verify>
  <done>Sidebar displays 3 stats above score: LINES, TIME (MM:SS format), PIECES count</done>
</task>

</tasks>

<verification>
Run game in browser:
1. Open index.html, verify sidebar shows "LINES: 0", "TIME: 00:00", "PIECES: 0"
2. Play for 30 seconds, clear some lines, verify stats update correctly
3. Observe freeze cycle: time continues counting, pieces counter pauses
4. Press R to restart, verify all stats reset to zero
5. Check browser console for errors (should be none)
</verification>

<success_criteria>
- [ ] js/stats.js created with startSession, updatePiecePlaced, getSessionTime, formatTime
- [ ] main.js calls startSession on game start/reset
- [ ] main.js calls updatePiecePlaced when piece locks
- [ ] Sidebar displays LINES, TIME, PIECES above score display
- [ ] Time format is MM:SS (e.g., "02:45")
- [ ] Stats update in real-time during gameplay
- [ ] Time continues during freeze cycles
- [ ] Stats reset when pressing R to restart
</success_criteria>

<output>
After completion, create `.planning/phases/06-session-statistics/06-01-SUMMARY.md`
</output>
