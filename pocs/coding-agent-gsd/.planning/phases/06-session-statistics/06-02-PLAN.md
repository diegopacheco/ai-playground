---
phase: 06-session-statistics
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified: [js/stats.js, js/render.js, index.html]
autonomous: false

must_haves:
  truths:
    - "Player sees PPS (pieces per second) calculated and displayed"
    - "Player sees APM (actions per minute) calculated and displayed"
    - "Game over screen shows complete session summary with all 7 metrics"
    - "Session summary is readable and well-formatted"
  artifacts:
    - path: "js/stats.js"
      provides: "Advanced stats calculation (PPS, APM, efficiency)"
      contains: "calculatePPS|calculateAPM|trackAction"
    - path: "js/render.js"
      provides: "Game over summary screen rendering"
      contains: "drawSessionSummary"
    - path: "index.html"
      provides: "No changes needed (canvas already sized)"
  key_links:
    - from: "js/main.js"
      to: "js/stats.js"
      via: "trackAction called on every player input"
      pattern: "trackAction"
    - from: "js/render.js"
      to: "js/stats.js"
      via: "reads advanced stats for display"
      pattern: "calculatePPS|calculateAPM"
---

<objective>
Add advanced performance metrics and comprehensive game over summary screen.

Purpose: Competitive players want detailed performance metrics. PPS (pieces per second), APM (actions per minute), and efficiency metrics provide insight into skill progression. Session summary on game over gives players a complete performance review.

Output: Advanced stats calculation, real-time PPS/APM display, and full-screen session summary on game over.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-session-statistics/06-01-SUMMARY.md
@js/stats.js
@js/main.js
@js/render.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add advanced stats calculation</name>
  <files>js/stats.js</files>
  <action>
Extend js/stats.js with advanced statistics tracking and calculations.

Add to stats object:
- actionsCount (total player inputs: move, rotate, drop, hold)

Add functions:
- trackAction() increments actionsCount
- calculatePPS() returns pieces per second (piecesPlaced / (getSessionTime() / 1000)), returns 0 if time is 0
- calculateAPM() returns actions per minute (actionsCount / (getSessionTime() / 60000)), returns 0 if time is 0
- calculateEfficiency() returns efficiency percentage ((piecesPlaced * 60) / actionsCount * 100), returns 0 if actionsCount is 0
- getTetrisRate() returns percentage of 4-line clears (for now returns 0, will be implemented in Phase 8)

Export all new functions.

Format helpers:
- formatDecimal(num, decimals) returns number formatted to N decimal places
- formatPercent(num) returns percentage formatted to 1 decimal place with % sign

Advanced metrics definitions:
- PPS: measures speed of piece placement (higher = faster play)
- APM: measures input rate (competitive Tetris metric, 100-200+ is skilled)
- Efficiency: measures how many pieces placed per 60 actions (higher = fewer wasted inputs)
- Tetris Rate: placeholder for Phase 8 T-spin feature
  </action>
  <verify>
grep -n "trackAction\|calculatePPS\|calculateAPM\|calculateEfficiency" js/stats.js
grep -n "actionsCount" js/stats.js
  </verify>
  <done>stats.js has trackAction, calculatePPS, calculateAPM, calculateEfficiency functions; actionsCount tracked in stats object</done>
</task>

<task type="auto">
  <name>Task 2: Track actions in input system</name>
  <files>js/main.js</files>
  <action>
Integrate action tracking in main.js input handling.

Call trackAction() for every player input:
- In movePiece() when move succeeds (left/right/down)
- In rotatePiece() when rotation succeeds
- In hardDrop() when executed
- In holdPiece() when executed (if hold function exists)

Check if holdPiece function exists in main.js. If not, check input.js for hold functionality.

Find existing input handlers and add trackAction() call immediately after successful action. Pattern:
```
if (actionSucceeded) {
    trackAction();
}
```

Do NOT track action on failed inputs (e.g., move blocked by wall). Only track actions that actually affect the game state.
  </action>
  <verify>
grep -n "trackAction()" js/main.js js/input.js
  </verify>
  <done>trackAction() called on every successful player input: move, rotate, hard drop, hold</done>
</task>

<task type="auto">
  <name>Task 3: Display advanced stats in sidebar</name>
  <files>js/render.js</files>
  <action>
Update drawSessionStats() to include PPS and APM below existing stats.

Current stats position (from Plan 06-01): y=295 to y=315
Extended stats section: y=295 to y=355 (60px height for 5 stats)

Display format:
```
LINES: 42
TIME: 02:45
PIECES: 128
PPS: 0.78
APM: 156
```

Font: 'bold 12px Arial', white color (#ffffff)
Left-align at sidebarX + 10

PPS and APM formatting:
- PPS: formatDecimal(calculatePPS(), 2)
- APM: Math.floor(calculateAPM())

Update y-position of existing SCORE label from 320 to 365 to make room for expanded stats.
Update y-position of LEVEL label from 400 to 445.

Verify sidebar height accommodates all elements. Current sidebar extends full board height (20+ rows * 30px = 600px+), so plenty of space.
  </action>
  <verify>
grep -n "PPS:\|APM:" js/render.js
grep -n "calculatePPS\|calculateAPM" js/render.js
  </verify>
  <done>Sidebar displays 5 stats: LINES, TIME, PIECES, PPS, APM with correct formatting</done>
</task>

<task type="auto">
  <name>Task 4: Create session summary screen</name>
  <files>js/render.js, js/main.js</files>
  <action>
Create comprehensive session summary displayed on game over.

1. In render.js, create drawSessionSummary() function:
   - Draws dark overlay (rgba(0, 0, 0, 0.85))
   - Centers white box (400px wide, 350px tall) on canvas
   - Title: "SESSION COMPLETE" (bold 28px, centered)
   - Stats grid (2 columns, left-aligned labels, right-aligned values):
     * Final Score: [score]
     * Lines Cleared: [lines]
     * Level Reached: [level]
     * Session Time: [formatTime]
     * Pieces Placed: [piecesPlaced]
     * PPS: [calculatePPS fixed to 2 decimals]
     * APM: [calculateAPM rounded]
   - Footer: "Press R to play again" (16px, centered)

2. In main.js, modify render() function:
   - Replace drawGameOver() call with drawSessionSummary() when gameState === GameState.GAME_OVER
   - drawSessionSummary() shows complete stats instead of simple "GAME OVER" text

Box styling:
- Background: rgba(20, 20, 20, 0.95)
- Border: 3px solid #00ffff
- Padding: 20px
- Border radius: not supported in canvas (skip)

Stats grid positioning:
- Title at boxY + 30
- Stats start at boxY + 80
- 35px spacing between rows
- Labels at boxX + 30, values at boxX + 370 (right-aligned)
- Footer at boxY + boxHeight - 30
  </action>
  <verify>
grep -n "drawSessionSummary" js/render.js
grep -n "SESSION COMPLETE" js/render.js
grep -n "drawSessionSummary" js/main.js
  </verify>
  <done>Game over shows session summary with all 7 metrics in formatted box; render() calls drawSessionSummary instead of drawGameOver</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Advanced stats tracking (PPS, APM, efficiency) integrated into gameplay, displayed in sidebar, and shown in session summary screen on game over.
  </what-built>
  <how-to-verify>
1. Open index.html in browser
2. Play game for 2-3 minutes:
   - Make moves, rotations, drops
   - Clear some lines
   - Observe sidebar stats update in real-time
3. Verify sidebar shows:
   - LINES (increasing with clears)
   - TIME (MM:SS format, continuously counting)
   - PIECES (increasing with each piece lock)
   - PPS (decimal number like 0.78)
   - APM (whole number like 156)
4. Let game reach game over state (stack to top)
5. Verify session summary screen displays:
   - "SESSION COMPLETE" title
   - All 7 stats with correct values
   - "Press R to play again" footer
   - Dark overlay with centered box
6. Press R to restart
7. Verify stats reset to zero
8. Check browser console for errors (should be none)
  </how-to-verify>
  <resume-signal>Type "approved" if session summary displays correctly with all metrics, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Automated checks:
- js/stats.js exports trackAction, calculatePPS, calculateAPM, calculateEfficiency
- js/main.js calls trackAction on player inputs
- js/render.js has drawSessionSummary function
- render() calls drawSessionSummary instead of drawGameOver

Manual verification:
- Play game and verify PPS/APM display updates
- Reach game over and verify session summary shows all stats
- Restart and verify stats reset
</verification>

<success_criteria>
- [ ] js/stats.js has trackAction, calculatePPS, calculateAPM, calculateEfficiency
- [ ] main.js tracks actions on every player input
- [ ] Sidebar displays PPS and APM with correct formatting
- [ ] Game over shows session summary screen instead of simple overlay
- [ ] Session summary displays all 7 metrics in formatted box
- [ ] Summary box is centered with dark overlay
- [ ] Stats reset correctly on restart
- [ ] Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/06-session-statistics/06-02-SUMMARY.md`
</output>
