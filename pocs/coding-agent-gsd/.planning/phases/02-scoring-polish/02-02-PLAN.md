# Plan 02-02: Ghost Piece & Next Preview

---
wave: 2
depends_on: [02-01]
files_modified:
  - js/render.js
  - js/main.js
autonomous: true
---

## Objective

Add ghost piece (landing preview) and next piece preview display.

## Requirements Addressed

- EHNC-01: Ghost piece shows landing position
- EHNC-03: Next piece preview displays upcoming piece

## Tasks

<task id="1">
Add ghost piece calculation in js/main.js.

Add getGhostY() function:
- Takes current piece and board
- Starts at piece.y
- Increments y while position is valid
- Returns the y position where piece would land
</task>

<task id="2">
Add ghost piece rendering in js/render.js.

Add drawGhost(pieceType, x, ghostY, rotation) function:
- Similar to drawPiece but with transparency
- Use ctx.globalAlpha = 0.3 before drawing
- Restore ctx.globalAlpha = 1.0 after
- Draw outline or filled with reduced opacity
</task>

<task id="3">
Update render() in js/main.js to draw ghost.

Before drawing current piece:
- Calculate ghostY = getGhostY(currentPiece, board)
- Call drawGhost(currentPiece.type, currentPiece.x, ghostY, currentPiece.rotation)
- Only draw ghost if ghostY != currentPiece.y (don't draw when piece is at landing spot)
</task>

<task id="4">
Add next piece preview state in js/main.js.

Modify bag/piece system:
- Add nextPiece variable to track upcoming piece
- On spawn: set currentPiece to nextPiece, generate new nextPiece
- Initialize both on game start
</task>

<task id="5">
Add next piece rendering in js/render.js.

Add drawNextPreview(pieceType) function:
- Draw "NEXT" label in sidebar
- Draw preview box below label
- Draw piece shape centered in preview box
- Scale piece to fit preview area (smaller than board cells)
</task>

<task id="6">
Update render() to draw next preview.

Call drawNextPreview(nextPiece) in render loop after drawSidebar().
</task>

## Verification

```
- [ ] Ghost piece visible below current piece
- [ ] Ghost piece follows current piece movement
- [ ] Ghost piece shows correct rotation
- [ ] Ghost piece has reduced opacity (semi-transparent)
- [ ] Ghost disappears when piece is at landing position
- [ ] "NEXT" label visible in sidebar
- [ ] Next piece preview shows correct upcoming piece
- [ ] Next piece changes after current piece locks
```

## Must Haves

1. Ghost piece renders at landing position
2. Ghost updates with piece movement/rotation
3. Next preview shows correct upcoming piece
4. Next preview updates when piece spawns
