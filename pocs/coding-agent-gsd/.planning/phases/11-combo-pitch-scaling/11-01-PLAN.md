---
phase: 11-combo-pitch-scaling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/audio.js
  - js/main.js
autonomous: true

must_haves:
  truths:
    - "Line clear sound pitch increases with combo counter"
    - "Pitch transitions are smooth without clicks or pops"
    - "Pitch stops increasing after 10x combo"
    - "Tetris clear sounds different from single line clear at same combo"
    - "Combo break resets pitch to base frequency"
  artifacts:
    - path: "js/audio.js"
      provides: "Combo-aware pitch scaling functions"
      contains: "exponentialRampToValueAtTime"
    - path: "js/main.js"
      provides: "Combo and linesCleared passed to audio functions"
      contains: "playLineClearSound(result.linesCleared, combo)"
  key_links:
    - from: "js/main.js"
      to: "playLineClearSound"
      via: "function call with combo parameter"
      pattern: "playLineClearSound\\(result\\.linesCleared,\\s*combo\\)"
    - from: "js/main.js"
      to: "playTetrisSound"
      via: "function call with combo parameter"
      pattern: "playTetrisSound\\(combo\\)"
    - from: "js/audio.js"
      to: "playSound"
      via: "frequency calculation with combo scaling"
      pattern: "Math\\.min\\(combo.*10\\)"
---

<objective>
Implement combo-based pitch scaling for line clear sounds so players hear escalating pitch feedback that rewards combo chains.

Purpose: Provides audio feedback that reinforces the combo mechanic, making consecutive line clears more satisfying.
Output: Updated audio.js with pitch scaling logic and main.js wired to pass combo values.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-combo-pitch-scaling/11-RESEARCH.md
@js/audio.js
@js/main.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pitch scaling to audio.js</name>
  <files>js/audio.js</files>
  <action>
Update playSound() to use parameter ramping instead of direct frequency assignment:
- Use setValueAtTime followed by exponentialRampToValueAtTime with 30ms ramp duration
- Add Nyquist limit check: cap frequency at ctx.sampleRate / 2 * 0.9

Update playLineClearSound() to accept (linesCleared, combo) parameters:
- Base frequencies by clear type: 1=330Hz, 2=440Hz, 3=550Hz, 4=660Hz
- Scaling formula: baseFrequency * (1 + 0.1 * Math.min(combo || 0, 10))
- Default combo to 0 if undefined for backward compatibility

Update playTetrisSound() to accept (combo) parameter:
- Base frequency: 660Hz (same as 4-line clear)
- Apply same scaling formula: 660 * (1 + 0.1 * Math.min(combo || 0, 10))
- Duration remains 200ms

Keep playLandSound() and playGameOverSound() unchanged (no pitch scaling needed).
  </action>
  <verify>Read audio.js and confirm: exponentialRampToValueAtTime present in playSound, playLineClearSound accepts two parameters, playTetrisSound accepts combo parameter, Nyquist limit check exists.</verify>
  <done>playSound uses parameter ramping with 30ms duration and Nyquist capping, playLineClearSound scales pitch by combo and clear type, playTetrisSound scales by combo.</done>
</task>

<task type="auto">
  <name>Task 2: Wire combo values to audio calls in main.js</name>
  <files>js/main.js</files>
  <action>
In the update() function around line 400-404, update the audio calls:
- Change playTetrisSound() to playTetrisSound(combo)
- Change playLineClearSound() to playLineClearSound(result.linesCleared, combo)

The combo variable is already in scope (module-level at line 21).
The result.linesCleared is already available from clearLines() return value.

No other changes needed - combo resets to 0 on line 286-287 when no lines cleared, which naturally resets pitch.
  </action>
  <verify>Read main.js lines 400-410 and confirm playTetrisSound(combo) and playLineClearSound(result.linesCleared, combo) are present.</verify>
  <done>playTetrisSound receives combo parameter, playLineClearSound receives linesCleared and combo parameters.</done>
</task>

</tasks>

<verification>
1. Open game and clear a single line - should hear 330Hz base pitch
2. Clear another line immediately (combo 2) - pitch should be noticeably higher
3. Build combo to 5+ and clear - pitch continues increasing
4. Build combo past 10 and clear - pitch stops increasing (capped)
5. Miss a line clear (combo resets) - next clear plays at base pitch
6. Clear 4 lines (Tetris) - should sound higher than single line at same combo
7. No clicks or pops during any pitch transition
</verification>

<success_criteria>
- PITCH-01: Line clear pitch scales with combo (0.1 per combo level)
- PITCH-02: No audio artifacts from smooth parameter ramping
- PITCH-03: Pitch capped at 10x combo multiplier
- PITCH-04: Different base frequencies for 1/2/3/4 line clears
- PITCH-05: Combo reset returns to base pitch
</success_criteria>

<output>
After completion, create `.planning/phases/11-combo-pitch-scaling/11-01-SUMMARY.md`
</output>
