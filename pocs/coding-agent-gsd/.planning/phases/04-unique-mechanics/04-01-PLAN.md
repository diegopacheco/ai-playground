---
phase: 04-unique-mechanics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/main.js
  - js/render.js
autonomous: true

must_haves:
  truths:
    - "Game alternates between 10s play and 10s freeze states"
    - "Freeze state shows blue overlay with FROZEN text"
    - "Countdown timer displays seconds remaining in freeze"
    - "Player cannot move or rotate pieces during freeze"
    - "Pause key still works during freeze state"
  artifacts:
    - path: "js/main.js"
      provides: "GameState enum, cycleTimer, state transitions"
      contains: "GameState.FROZEN"
    - path: "js/render.js"
      provides: "Freeze overlay rendering"
      contains: "drawFreezeOverlay"
  key_links:
    - from: "js/main.js"
      to: "GameState check"
      via: "update() and processInput() early returns"
      pattern: "gameState === GameState.FROZEN"
    - from: "js/render.js"
      to: "js/main.js"
      via: "render() calls drawFreezeOverlay when frozen"
      pattern: "drawFreezeOverlay"
---

<objective>
Implement freeze cycle mechanics - game alternates between 10-second play and 10-second freeze periods with visual feedback.

Purpose: Creates the signature "freeze" mechanic that distinguishes this Tetris variant, adding tension where players can see but not act.
Output: Working freeze/play cycle with overlay, countdown, and input blocking.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-unique-mechanics/04-RESEARCH.md
@js/main.js
@js/render.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GameState enum and cycle timer logic</name>
  <files>js/main.js</files>
  <action>
Add GameState enum at top of file (after variable declarations):
```javascript
const GameState = Object.freeze({
    PLAYING: 'PLAYING',
    FROZEN: 'FROZEN',
    PAUSED: 'PAUSED',
    GAME_OVER: 'GAME_OVER'
});
```

Add state variables after existing declarations:
- `let gameState = GameState.PLAYING;`
- `let cycleTimer = 0;`
- `const PLAY_DURATION = 10000;`
- `const FREEZE_DURATION = 10000;`

Remove existing `isPaused` boolean (replaced by GameState.PAUSED).

Update togglePause() to use GameState:
```javascript
function togglePause() {
    if (gameState === GameState.GAME_OVER) return;
    if (gameState === GameState.PAUSED) {
        gameState = GameState.PLAYING;
    } else if (gameState === GameState.PLAYING || gameState === GameState.FROZEN) {
        gameState = GameState.PAUSED;
    }
}
```

Update update() function:
- Replace `if (gameOver) return;` with `if (gameState === GameState.GAME_OVER) return;`
- Replace `if (isPaused) return;` with `if (gameState === GameState.PAUSED) return;`
- Add cycle timer logic after pause check:
```javascript
cycleTimer += deltaTime;
if (gameState === GameState.PLAYING && cycleTimer >= PLAY_DURATION) {
    gameState = GameState.FROZEN;
    cycleTimer = 0;
} else if (gameState === GameState.FROZEN && cycleTimer >= FREEZE_DURATION) {
    gameState = GameState.PLAYING;
    cycleTimer = 0;
}
if (gameState === GameState.FROZEN) return;
```

Update processInput():
- Add after pause handling: `if (gameState === GameState.FROZEN) return;`
- Replace `if (isPaused) return;` with `if (gameState === GameState.PAUSED) return;`

Update gameOver setting: When setting `gameOver = true`, also set `gameState = GameState.GAME_OVER`.

Update resetGame():
- Add `gameState = GameState.PLAYING;`
- Add `cycleTimer = 0;`
- Remove `isPaused = false;` line

Update render():
- Replace `if (isPaused)` with `if (gameState === GameState.PAUSED)`
- Replace `if (gameOver)` with `if (gameState === GameState.GAME_OVER)`

Update STATS_RESPONSE to use `paused: gameState === GameState.PAUSED` and `gameOver: gameState === GameState.GAME_OVER`.
  </action>
  <verify>Open index.html in browser. Game should freeze after 10 seconds (pieces stop falling), then resume after another 10 seconds. Pause with P key should still work.</verify>
  <done>GameState enum controls game flow, cycle timer transitions between PLAYING and FROZEN every 10 seconds, input blocked during freeze.</done>
</task>

<task type="auto">
  <name>Task 2: Add freeze overlay rendering with countdown</name>
  <files>js/render.js, js/main.js</files>
  <action>
In js/render.js, add drawFreezeOverlay function after drawPaused():
```javascript
function drawFreezeOverlay(remainingMs) {
    ctx.fillStyle = 'rgba(50, 150, 255, 0.5)';
    ctx.fillRect(0, 0, COLS * CELL_SIZE, ROWS * CELL_SIZE);

    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 48px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('FROZEN', (COLS * CELL_SIZE) / 2, (ROWS * CELL_SIZE) / 2 - 30);

    var remainingSeconds = Math.ceil(remainingMs / 1000);
    ctx.fillStyle = '#00ffff';
    ctx.font = 'bold 36px Arial';
    ctx.fillText(remainingSeconds + 's', (COLS * CELL_SIZE) / 2, (ROWS * CELL_SIZE) / 2 + 30);
}
```

In js/main.js render() function, add freeze overlay rendering after drawSidebar() and before pause/gameOver checks:
```javascript
if (gameState === GameState.FROZEN) {
    drawFreezeOverlay(FREEZE_DURATION - cycleTimer);
}
```
  </action>
  <verify>Open index.html. After 10 seconds of play, screen shows blue semi-transparent overlay with "FROZEN" text and countdown from 10s to 1s.</verify>
  <done>Freeze state displays clear visual indicator (blue overlay, FROZEN text) and countdown timer showing seconds remaining.</done>
</task>

</tasks>

<verification>
1. Start game, play normally for ~10 seconds
2. Game freezes - blue overlay appears with "FROZEN" and "10s" countdown
3. Countdown decrements each second (10, 9, 8... 1)
4. After countdown reaches 0, overlay disappears, game resumes
5. Cycle repeats (10s play, 10s freeze)
6. During freeze: arrow keys, space, rotation have no effect
7. During freeze: P key pauses game (overlay changes to PAUSED)
8. After unpausing during freeze: freeze continues where it left off
</verification>

<success_criteria>
- UNIQ-01: Game alternates 10s play / 10s freeze cycles
- UNIQ-02: Freeze state has clear visual indicator (blue overlay, FROZEN text) and countdown
- Pause functionality preserved during freeze
- No input processed during freeze except pause
</success_criteria>

<output>
After completion, create `.planning/phases/04-unique-mechanics/04-01-SUMMARY.md`
</output>
