---
phase: 09-audio-feedback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/audio.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "Audio module exports playable sound functions"
    - "AudioContext singleton pattern prevents multiple contexts"
    - "Sound effects use OscillatorNode (no audio files)"
    - "Mute state persists to localStorage"
  artifacts:
    - path: "js/audio.js"
      provides: "Audio system with sound effects"
      exports: ["playLandSound", "playLineClearSound", "playTetrisSound", "playGameOverSound", "initAudio", "isMuted", "setMuted"]
      min_lines: 60
  key_links:
    - from: "index.html"
      to: "js/audio.js"
      via: "script tag"
      pattern: "script.*audio\\.js"
---

<objective>
Create the audio module with Web Audio API OscillatorNode-based sound effects and mute state management.

Purpose: Foundation for all game audio - provides sound functions and mute persistence that other code can call.
Output: js/audio.js module with exported sound functions, AudioContext singleton, and mute state handling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-audio-feedback/09-RESEARCH.md

@js/main.js
@js/sync.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audio.js with AudioContext singleton and sound effects</name>
  <files>js/audio.js</files>
  <action>
Create js/audio.js with:

1. AudioContext singleton pattern:
   - Global audioContext variable (initially null)
   - getAudioContext() function that creates context on first call
   - Checks audioContext.state === 'suspended' and calls resume()
   - Single context shared across all sound functions

2. Mute state management:
   - Global muted variable (initially false)
   - initAudio() function that reads from localStorage('audio_muted')
   - isMuted() function returns current mute state
   - setMuted(value) function that updates state, persists to localStorage, and broadcasts via BroadcastChannel

3. Sound effect functions using OscillatorNode:
   - playLandSound(): 220 Hz, sine wave, 100ms duration
   - playLineClearSound(): 440 Hz, sine wave, 100ms duration
   - playTetrisSound(): 880 Hz, sine wave, 200ms duration
   - playGameOverSound(): 110 Hz, sine wave, 500ms duration

4. Each sound function:
   - Checks if muted, returns early if true
   - Gets AudioContext via getAudioContext()
   - Creates OscillatorNode and GainNode
   - Connects oscillator -> gain -> destination
   - Sets frequency and waveform type
   - Uses exponentialRampToValueAtTime(0.01, ...) for smooth stop (never 0, causes error)
   - Starts and stops oscillator with scheduled times

5. BroadcastChannel for mute sync:
   - Use existing 'tetris-sync' channel pattern from sync.js
   - Listen for MUTE_CHANGE messages and update local mute state
   - When setMuted called, broadcast MUTE_CHANGE

6. Autoplay policy handling:
   - Document click listener with { once: true } to resume context on first interaction
  </action>
  <verify>
File js/audio.js exists with all required exports:
- getAudioContext returns AudioContext instance
- playLandSound, playLineClearSound, playTetrisSound, playGameOverSound are callable
- initAudio reads from localStorage
- setMuted persists to localStorage and broadcasts
  </verify>
  <done>
Audio module exists with singleton AudioContext, 4 sound effect functions, and mute state management with localStorage persistence and BroadcastChannel sync.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add audio.js script to index.html</name>
  <files>index.html</files>
  <action>
Add script tag for js/audio.js to index.html, placed AFTER sync.js (audio.js uses BroadcastChannel from sync pattern) and BEFORE main.js (main.js will call audio functions).

Script order should be:
1. sync.js (channel infrastructure)
2. audio.js (audio module)
3. Other modules...
4. main.js (uses audio)
  </action>
  <verify>
index.html contains script tag for js/audio.js in correct position
  </verify>
  <done>
index.html loads audio.js before main.js so audio functions are available when main.js initializes.
  </done>
</task>

</tasks>

<verification>
1. js/audio.js file exists
2. File contains getAudioContext, playLandSound, playLineClearSound, playTetrisSound, playGameOverSound, initAudio, isMuted, setMuted
3. index.html includes audio.js script tag
4. No syntax errors when loading page
</verification>

<success_criteria>
- Audio module creates AudioContext singleton on first sound call
- Four distinct sound effects with different frequencies/durations
- Mute state reads from localStorage on init
- setMuted persists to localStorage
- BroadcastChannel integration for cross-tab mute sync
- Page loads without JavaScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-audio-feedback/09-01-SUMMARY.md`
</output>
