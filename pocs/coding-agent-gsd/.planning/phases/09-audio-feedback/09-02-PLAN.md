---
phase: 09-audio-feedback
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - js/main.js
  - js/admin.js
  - admin.html
autonomous: false

must_haves:
  truths:
    - "Player hears sound when piece locks"
    - "Player hears sound when lines clear"
    - "Player hears distinct higher sound for Tetris (4-line)"
    - "Player hears sound on game over"
    - "Admin can toggle mute and setting persists across sessions"
  artifacts:
    - path: "js/main.js"
      provides: "Audio trigger calls"
      contains: ["playLandSound", "playLineClearSound", "playTetrisSound", "playGameOverSound"]
    - path: "js/admin.js"
      provides: "Mute toggle handler"
      contains: ["setMuted", "MUTE_CHANGE"]
    - path: "admin.html"
      provides: "Mute toggle UI"
      contains: ["mute-toggle"]
  key_links:
    - from: "js/main.js"
      to: "js/audio.js"
      via: "function calls on game events"
      pattern: "play(Land|LineClear|Tetris|GameOver)Sound"
    - from: "js/admin.js"
      to: "js/audio.js"
      via: "mute toggle"
      pattern: "setMuted"
    - from: "admin.html"
      to: "js/admin.js"
      via: "checkbox event"
      pattern: "mute-toggle"
---

<objective>
Wire audio triggers into game events and add mute toggle to admin panel.

Purpose: Complete audio integration - sounds play on game events, admin controls mute state.
Output: Working audio feedback for piece land, line clear, Tetris, game over, with admin mute control.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-audio-feedback/09-RESEARCH.md
@.planning/phases/09-audio-feedback/09-01-SUMMARY.md

@js/main.js
@js/admin.js
@admin.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire audio triggers into main.js game events</name>
  <files>js/main.js</files>
  <action>
Modify js/main.js to trigger audio on game events:

1. In DOMContentLoaded event handler, call initAudio() to initialize mute state from localStorage

2. In lockPieceToBoard() function:
   - After calling lockPiece(board, currentPiece), call playLandSound()
   - This triggers on every piece lock (AUDIO-01)

3. In update() function, in the clearingTimer block where lines are processed:
   - After clearing lines and calculating score, check result.linesCleared
   - If result.linesCleared === 4, call playTetrisSound() (AUDIO-03)
   - Else if result.linesCleared > 0, call playLineClearSound() (AUDIO-02)

4. In spawnPiece() or where game over is detected:
   - When gameOver = true and gameState = GameState.GAME_OVER is set, call playGameOverSound() (AUDIO-04)

5. Add MUTE_CHANGE handler to channel.onmessage:
   - When receiving MUTE_CHANGE message, call setMuted(payload.muted)
   - This syncs mute state from admin panel

Audio trigger locations:
- AUDIO-01 (piece land): lockPieceToBoard() after board = lockPiece(...)
- AUDIO-02 (line clear): update() in clearingTimer block for 1-3 lines
- AUDIO-03 (Tetris): update() in clearingTimer block for 4 lines
- AUDIO-04 (game over): spawnPiece() when gameOver is set
  </action>
  <verify>
Open game in browser, play until piece locks - should hear 220Hz sound.
Clear 1-3 lines - should hear 440Hz sound.
Clear 4 lines (Tetris) - should hear 880Hz higher sound.
Reach game over - should hear 110Hz low sound.
  </verify>
  <done>
All four audio events trigger: piece lock plays land sound, 1-3 line clear plays clear sound, Tetris plays higher-pitched sound, game over plays low final sound.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add mute toggle to admin panel with persistence</name>
  <files>admin.html, js/admin.js</files>
  <action>
Modify admin.html:
1. Add new section after Live Stats section for Audio Controls
2. Add checkbox input with id="mute-toggle" and label "Mute Sound Effects"
3. Style consistently with existing admin panel theme

Modify js/admin.js:
1. At top, read initial mute state from localStorage('audio_muted')
2. Set checkbox checked state based on stored value
3. Add change event listener to mute-toggle checkbox
4. On change, post MUTE_CHANGE message via channel with { muted: checkbox.checked }
5. Also store to localStorage('audio_muted', JSON.stringify(checked))
6. Listen for MUTE_CHANGE messages from game and update checkbox state

HTML structure for mute section:
```html
<div class="section">
    <h2>Audio</h2>
    <label class="checkbox-label">
        <input type="checkbox" id="mute-toggle">
        <span>Mute Sound Effects</span>
    </label>
</div>
```

Add CSS for checkbox styling to match admin panel theme.
  </action>
  <verify>
1. Open admin.html - mute checkbox visible
2. Toggle mute checkbox - localStorage updates
3. Refresh page - checkbox retains state from localStorage
4. With game open, toggle mute in admin - game stops playing sounds
5. Unmute in admin - game resumes playing sounds
  </verify>
  <done>
Admin panel has mute toggle. Mute state persists to localStorage. Toggle syncs to game via BroadcastChannel. State survives page refresh.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete audio feedback system with 4 distinct sounds and admin mute control</what-built>
  <how-to-verify>
1. Open index.html in browser
2. Click anywhere to enable audio (browser autoplay policy)
3. Play until piece lands - should hear 220Hz beep
4. Clear 1-3 lines - should hear 440Hz beep
5. Clear 4 lines (Tetris) - should hear 880Hz higher beep
6. Stack to game over - should hear 110Hz low sound
7. Open admin.html in new tab
8. Toggle "Mute Sound Effects" checkbox to checked
9. Play game - should hear no sounds
10. Refresh admin page - checkbox should still be checked (persisted)
11. Uncheck mute - sounds should resume in game
  </how-to-verify>
  <resume-signal>Type "approved" if all sounds work and mute toggle persists, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Open game, click to enable audio
2. Piece lock produces distinct sound
3. Line clear produces different sound
4. Tetris produces higher-pitched sound
5. Game over produces low sound
6. Admin panel shows mute toggle
7. Mute toggle stops all game sounds
8. Mute setting persists after admin page refresh
9. Mute syncs between admin and game tabs
</verification>

<success_criteria>
- AUDIO-01: Piece lock triggers 220Hz sound
- AUDIO-02: Line clear (1-3) triggers 440Hz sound
- AUDIO-03: Tetris (4-line) triggers 880Hz sound
- AUDIO-04: Game over triggers 110Hz sound
- AUDIO-05: Mute toggle in admin persists to localStorage and syncs across tabs
</success_criteria>

<output>
After completion, create `.planning/phases/09-audio-feedback/09-02-SUMMARY.md`
</output>
