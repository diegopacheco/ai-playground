---
phase: 07-combo-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [js/main.js]
autonomous: true

must_haves:
  truths:
    - "Combo counter increments on consecutive line clears"
    - "Combo resets when piece locks without clearing lines"
    - "Combo bonus points (50 x combo x level) add to score"
    - "Back-to-Back active when consecutive Tetris clears occur"
    - "Back-to-Back awards 1.5x points on Tetris when active"
  artifacts:
    - path: "js/main.js"
      provides: "Combo and B2B state management, scoring integration"
      contains: "let combo = 0"
  key_links:
    - from: "lockPieceToBoard()"
      to: "combo state"
      via: "combo++ on lines cleared, combo = 0 on no lines"
      pattern: "combo\\+\\+|combo = 0"
    - from: "score calculation"
      to: "combo bonus"
      via: "50 * combo * level addition"
      pattern: "50 \\* combo"
---

<objective>
Implement combo and Back-to-Back scoring mechanics in the game engine.

Purpose: Enable players to earn bonus points for consecutive line clears, following Tetris Guideline standards.
Output: Updated main.js with combo state tracking, B2B state tracking, and integrated scoring formulas.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-combo-system/07-RESEARCH.md
@js/main.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add combo and B2B state variables</name>
  <files>js/main.js</files>
  <action>
Add state variables after line 20 (after themeIndex):
- `let combo = 0;` - tracks consecutive line clears
- `let b2bActive = false;` - tracks Back-to-Back chain state

These variables persist across piece placements. Combo increments on line clear, resets on piece lock without clear. B2B activates on Tetris (4-line clear), deactivates on non-Tetris line clear, persists through non-clearing placements.
  </action>
  <verify>grep -n "let combo" js/main.js && grep -n "let b2bActive" js/main.js</verify>
  <done>State variables exist at module level in main.js</done>
</task>

<task type="auto">
  <name>Task 2: Update lockPieceToBoard with combo and B2B logic</name>
  <files>js/main.js</files>
  <action>
Modify lockPieceToBoard() function (lines 193-207) to:

1. When lines.length > 0:
   - Increment combo (combo++)
   - Check if isDifficultClear (lines.length === 4)
   - Determine if B2B bonus applies (b2bActive && isDifficultClear)
   - Store pending score calculation info: { linesCleared, comboValue, hasB2bBonus }
   - Update b2bActive: set true if isDifficultClear, false otherwise

2. When lines.length === 0:
   - Reset combo to 0 (combo = 0)
   - Do NOT change b2bActive (B2B persists through non-clearing placements)

The combo value used for scoring is the NEW value after increment (first consecutive clear = combo 1, bonus starts applying from combo 2).
  </action>
  <verify>grep -A 20 "function lockPieceToBoard" js/main.js | grep -E "combo|b2bActive"</verify>
  <done>lockPieceToBoard increments combo on clears, resets on no-clear, manages b2bActive state</done>
</task>

<task type="auto">
  <name>Task 3: Integrate combo and B2B into score calculation</name>
  <files>js/main.js</files>
  <action>
Modify the score calculation in update() function (around lines 278-289, in the clearingTimer <= 0 block):

Current code:
score += result.linesCleared * pointsPerRow;

Replace with enhanced scoring:
1. Calculate base line score using existing formula
2. Apply B2B multiplier (1.5x) if pending hasB2bBonus and linesCleared === 4
3. Calculate combo bonus: 50 * (combo - 1) * level (bonus starts from 2nd consecutive clear)
4. Add both base score and combo bonus to total score

Store pendingScoreCalc when lines are detected in lockPieceToBoard, use it in update() when clearing completes. Clear pendingScoreCalc after use.

Add pendingScoreCalc variable at module level: `let pendingScoreCalc = null;`

Update resetGame() to reset: combo = 0, b2bActive = false, pendingScoreCalc = null
  </action>
  <verify>grep -A 15 "if (clearingTimer <= 0)" js/main.js | grep -E "combo|b2b|pending"</verify>
  <done>Score calculation includes combo bonus and B2B multiplier, resetGame clears all combo state</done>
</task>

</tasks>

<verification>
1. Open game in browser, clear single line - no combo bonus (combo = 1, bonus starts at 2)
2. Clear another line immediately - combo = 2, bonus of 50 * 1 * level added
3. Lock piece without clearing - combo resets to 0
4. Clear 4 lines (Tetris) - b2bActive becomes true
5. Clear another Tetris - 1.5x multiplier applies, B2B stays active
6. Clear 1-3 lines after Tetris - B2B deactivates
</verification>

<success_criteria>
- Combo counter tracks consecutive clears correctly (1, 2, 3...)
- Combo bonus (50 * (combo-1) * level) adds to score from 2nd consecutive clear
- B2B activates on Tetris, deactivates on non-Tetris clear
- B2B 1.5x multiplier applies to Tetris when B2B active
- resetGame clears all combo/b2b state
</success_criteria>

<output>
After completion, create `.planning/phases/07-combo-system/07-01-SUMMARY.md`
</output>
