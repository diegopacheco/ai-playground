---
phase: 07-combo-system
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified: [js/render.js, js/stats.js]
autonomous: false

must_haves:
  truths:
    - "Visual combo counter displays during active combo"
    - "Back-to-Back indicator shows when B2B is active"
    - "maxCombo stat tracks highest combo achieved in session"
    - "b2bCount stat tracks total B2B bonuses awarded"
  artifacts:
    - path: "js/render.js"
      provides: "Combo and B2B visual indicators in sidebar"
      contains: "function drawComboIndicator"
    - path: "js/stats.js"
      provides: "Combo statistics tracking"
      contains: "maxCombo"
  key_links:
    - from: "drawSessionStats()"
      to: "drawComboIndicator()"
      via: "function call"
      pattern: "drawComboIndicator"
    - from: "stats object"
      to: "maxCombo, b2bCount"
      via: "object properties"
      pattern: "stats\\.maxCombo|stats\\.b2bCount"
---

<objective>
Add visual combo display and statistics tracking for combo system.

Purpose: Provide player feedback for combo chains and B2B bonuses, track performance metrics.
Output: Updated render.js with combo indicator, updated stats.js with combo statistics.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-combo-system/07-RESEARCH.md
@.planning/phases/07-combo-system/07-01-SUMMARY.md
@js/render.js
@js/stats.js
@js/main.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add combo statistics to stats.js</name>
  <files>js/stats.js</files>
  <action>
1. Add to stats object (after actionsCount):
   - maxCombo: 0 - highest combo achieved in session
   - b2bCount: 0 - total Back-to-Back bonuses awarded

2. Update startSession() to reset:
   - stats.maxCombo = 0
   - stats.b2bCount = 0

3. Add function updateComboStats(currentCombo):
   - If currentCombo > stats.maxCombo, set stats.maxCombo = currentCombo
   - Export in module.exports

4. Add function incrementB2bCount():
   - Increment stats.b2bCount++
   - Export in module.exports
  </action>
  <verify>grep -n "maxCombo\|b2bCount\|updateComboStats\|incrementB2bCount" js/stats.js</verify>
  <done>stats.js has maxCombo, b2bCount, updateComboStats(), incrementB2bCount()</done>
</task>

<task type="auto">
  <name>Task 2: Add visual combo indicator in render.js</name>
  <files>js/render.js</files>
  <action>
Add function drawComboIndicator(combo, b2bActive) after drawSessionStats():

1. Early return if combo <= 0 AND b2bActive is false (nothing to display)

2. Position: Below session stats in sidebar
   - sidebarX = COLS * CELL_SIZE
   - comboY = 375 (after session stats, before score)

3. If combo > 0:
   - Draw combo text centered: combo + "x COMBO"
   - Color: magenta (#ff00ff)
   - Font: bold 16px Arial
   - Center text: sidebarX + SIDEBAR_WIDTH / 2

4. If b2bActive:
   - Draw "BACK-TO-BACK" below combo
   - Color: yellow (#ffff00)
   - Font: bold 12px Arial
   - Position: comboY + 18 (below combo text)

Call drawComboIndicator(combo, b2bActive) from main.js render() after drawSessionStats().
  </action>
  <verify>grep -A 20 "function drawComboIndicator" js/render.js</verify>
  <done>drawComboIndicator renders combo count and B2B indicator in sidebar</done>
</task>

<task type="auto">
  <name>Task 3: Wire combo display and stats in main.js</name>
  <files>js/main.js</files>
  <action>
1. In render() function, after drawSessionStats():
   - Add: drawComboIndicator(combo, b2bActive);

2. In lockPieceToBoard() when combo increments:
   - Call: updateComboStats(combo);

3. In update() when B2B bonus is applied:
   - Call: incrementB2bCount();

4. In drawSessionSummary (render.js), add max combo and B2B count:
   - After APM row (rowHeight * 6), add:
   - "Max Combo:" label with stats.maxCombo value (rowHeight * 7)
   - "B2B Bonuses:" label with stats.b2bCount value (rowHeight * 8)
   - Increase boxHeight from 320 to 380 to accommodate new rows
  </action>
  <verify>grep -n "drawComboIndicator\|updateComboStats\|incrementB2bCount" js/main.js js/render.js</verify>
  <done>Combo display renders during gameplay, stats track combo and B2B performance</done>
</task>

</tasks>

<verification>
1. Open game in browser
2. Clear a line - "1x COMBO" appears in sidebar
3. Clear another line immediately - "2x COMBO" appears
4. Lock piece without clearing - combo display disappears
5. Clear Tetris (4 lines) - "BACK-TO-BACK" appears below combo
6. Clear another Tetris - B2B indicator stays, bonus awarded
7. Lose game - summary shows Max Combo and B2B Bonuses stats
</verification>

<success_criteria>
- Combo counter visible in sidebar during active combo
- B2B indicator visible during active B2B chain
- maxCombo stat shows highest combo achieved on game over
- b2bCount stat shows total B2B bonuses on game over
- Session summary includes combo statistics
</success_criteria>

<output>
After completion, create `.planning/phases/07-combo-system/07-02-SUMMARY.md`
</output>
