---
phase: 08-t-spin-detection
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified: [js/render.js, js/main.js]
autonomous: false

must_haves:
  truths:
    - "Visual indicator displays T-Spin Mini when mini detected"
    - "Visual indicator displays T-Spin when full detected"
    - "T-spin indicator shows line count (Single, Double, Triple)"
    - "Indicator visible in sidebar alongside combo/B2B display"
    - "Session summary shows T-spin count"
  artifacts:
    - path: "js/render.js"
      provides: "T-spin indicator rendering"
      contains: "drawTSpinIndicator"
    - path: "js/main.js"
      provides: "T-spin display state and render call"
      contains: "tSpinDisplay"
  key_links:
    - from: "update()"
      to: "tSpinDisplay"
      via: "sets display state when T-spin detected"
      pattern: "tSpinDisplay"
    - from: "render()"
      to: "drawTSpinIndicator()"
      via: "calls indicator draw function"
      pattern: "drawTSpinIndicator"
    - from: "drawSessionSummary()"
      to: "stats.tSpinCount"
      via: "displays T-spin count in summary"
      pattern: "T-Spins"
---

<objective>
Add visual feedback for T-spin detection with indicator display and session summary integration.

Purpose: Players see recognition for their T-spin moves through on-screen indicators, enhancing game feel and confirming detection works correctly.
Output: Working T-spin visual indicator in sidebar, T-spin count in session summary screen.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-t-spin-detection/08-RESEARCH.md
@.planning/phases/08-t-spin-detection/08-01-SUMMARY.md
@js/main.js
@js/render.js
@js/stats.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add T-spin display state and indicator rendering</name>
  <files>js/main.js, js/render.js</files>
  <action>
In main.js:
- Add state variable: let tSpinDisplay = null;
- Add state variable: let tSpinDisplayTimer = 0;
- Add constant: const TSPIN_DISPLAY_DURATION = 1500;

In main.js update() function, in the clearingTimer block (after lines are cleared):
- If pendingScoreCalc.tSpinType is not null, set tSpinDisplay = { type: pendingScoreCalc.tSpinType, lines: result.linesCleared }; and tSpinDisplayTimer = TSPIN_DISPLAY_DURATION;

Add T-spin display timer update in update() function (before the clearingLines check):
- If tSpinDisplayTimer > 0, decrement by deltaTime
- If tSpinDisplayTimer reaches 0 or below, set tSpinDisplay = null

In main.js resetGame():
- Add tSpinDisplay = null and tSpinDisplayTimer = 0 to reset block

In main.js render():
- Modify drawComboIndicator call to include tSpinDisplay: drawComboIndicator(combo, b2bActive, tSpinDisplay);

In render.js:
- Modify drawComboIndicator function signature to accept third parameter: function drawComboIndicator(combo, b2bActive, tSpinDisplay)

Add T-spin indicator rendering at the top of drawComboIndicator function:
- If tSpinDisplay is not null:
  - var sidebarX = COLS * CELL_SIZE;
  - var centerX = sidebarX + SIDEBAR_WIDTH / 2;
  - var tSpinY = 260;
  - ctx.fillStyle = '#ff00ff';
  - ctx.font = 'bold 14px Arial';
  - ctx.textAlign = 'center';
  - ctx.textBaseline = 'top';
  - var tSpinText = tSpinDisplay.type === 'mini' ? 'T-SPIN MINI' : 'T-SPIN';
  - if (tSpinDisplay.lines > 0):
    - var lineNames = ['', 'SINGLE', 'DOUBLE', 'TRIPLE'];
    - tSpinText = tSpinText + ' ' + lineNames[tSpinDisplay.lines];
  - ctx.fillText(tSpinText, centerX, tSpinY);

Position the T-spin indicator at Y=260 (between session stats and combo indicator at Y=375).
  </action>
  <verify>
Read js/main.js and js/render.js and confirm:
- tSpinDisplay and tSpinDisplayTimer state variables exist
- update() sets tSpinDisplay when T-spin detected
- tSpinDisplayTimer counts down and clears display
- render() passes tSpinDisplay to drawComboIndicator
- drawComboIndicator renders T-spin text when tSpinDisplay not null
- T-spin indicator positioned at Y=260 in sidebar
- Text shows type (T-SPIN or T-SPIN MINI) with line count
  </verify>
  <done>
T-spin indicator displays in sidebar showing "T-SPIN MINI" or "T-SPIN" with line count (SINGLE/DOUBLE/TRIPLE) for 1.5 seconds after detection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add T-spin count to session summary</name>
  <files>js/render.js</files>
  <action>
In render.js drawSessionSummary():
- The current summary shows 9 rows of stats (Final Score through B2B Bonuses at rowHeight * 8)
- Increase boxHeight from 380 to 410 to accommodate one more row
- Add T-Spins row after B2B Bonuses (at statsStartY + rowHeight * 9):
  - ctx.textAlign = 'left';
  - ctx.fillStyle = '#ffffff';
  - ctx.fillText('T-Spins:', boxX + 20, statsStartY + rowHeight * 9);
  - ctx.textAlign = 'right';
  - ctx.fillStyle = '#ff00ff';
  - ctx.fillText(stats.tSpinCount.toString(), boxX + boxWidth - 20, statsStartY + rowHeight * 9);

Make sure the "Press R to play again" text stays at boxY + boxHeight - 30 (will auto-adjust with new boxHeight).
  </action>
  <verify>
Read js/render.js drawSessionSummary and confirm:
- boxHeight increased to 410
- T-Spins row displays at statsStartY + rowHeight * 9
- Label is white (#ffffff), value is magenta (#ff00ff)
- Value shows stats.tSpinCount
  </verify>
  <done>
Session summary displays T-spin count with consistent styling, showing total T-spins performed during the session.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete T-spin detection system with visual indicator and session summary</what-built>
  <how-to-verify>
1. Open index.html in browser
2. Play the game normally (drop pieces without rotating) - no T-spin indicator should appear
3. Wait for a T-piece, position it near corner or tight space
4. Rotate T-piece into position with 3+ corners blocked - should see "T-SPIN MINI" or "T-SPIN" indicator in sidebar
5. If T-spin clears lines, indicator should show "T-SPIN SINGLE", "T-SPIN DOUBLE", etc.
6. Verify indicator displays for about 1.5 seconds then disappears
7. Perform T-spin that clears 4 lines (T-spin Triple not possible, max is Double for mini, Triple for full in standard Tetris)
8. Check scoring: mini with 1 line = 200 * level, full with 1 line = 800 * level
9. Perform consecutive T-spin line clears - should see BACK-TO-BACK indicator
10. Let game end (stack to top)
11. Check session summary - should show "T-Spins: X" where X is the count of T-spins performed
12. Press R to restart, verify T-spin count resets
  </how-to-verify>
  <resume-signal>Type "approved" if T-spin detection, indicator, and summary work correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. T-spin indicator appears only after rotation into tight space
2. Indicator shows correct type (MINI vs full)
3. Indicator shows line count when lines cleared
4. Indicator displays for ~1.5 seconds
5. Indicator positioned correctly in sidebar (Y=260, below stats)
6. Session summary includes T-spin count
7. T-spin count resets on game restart
8. Multiple T-spin types display correctly in sequence
</verification>

<success_criteria>
- Visual indicator displays T-spin type on detection
- Mini shows "T-SPIN MINI", full shows "T-SPIN"
- Line clears append SINGLE/DOUBLE/TRIPLE
- Indicator positioned in sidebar below session stats
- Session summary includes T-spin count
- Indicator clears after duration expires
- All Phase 8 requirements (TSPN-01 through TSPN-05) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/08-t-spin-detection/08-02-SUMMARY.md`
</output>
