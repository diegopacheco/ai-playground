# Plan 01-02: Tetrominoes & Movement

---
wave: 2
depends_on: [01-01]
files_modified:
  - js/pieces.js
  - js/input.js
  - js/board.js
  - js/render.js
  - js/main.js
autonomous: true
---

## Objective

Implement the 7 tetrominoes with rotation states, wall kicks, and player input handling.

## Requirements Addressed

- CORE-02: 7 standard tetrominoes spawn (I, O, T, S, Z, J, L)
- CORE-04: Player can move piece left/right with arrow keys
- CORE-05: Player can soft drop with down arrow
- CORE-06: Player can hard drop with spacebar
- CORE-07: Player can rotate piece clockwise with up arrow
- CORE-08: Rotation uses wall kicks when near edges

## Tasks

<task id="1">
Create js/pieces.js with tetromino definitions.

Implement all 7 pieces with 4 rotation states each:
- I (cyan): 4x4 grid, horizontal/vertical
- O (yellow): 2x2 grid, same all rotations
- T (purple): 3x3 grid
- S (green): 3x3 grid
- Z (red): 3x3 grid
- J (blue): 3x3 grid
- L (orange): 3x3 grid

Data structure per piece:
```javascript
{
  name: 'T',
  color: '#800080',
  shapes: [
    [[0,1,0],[1,1,1],[0,0,0]],  // rotation 0
    [[0,1,0],[0,1,1],[0,1,0]],  // rotation 1
    [[0,0,0],[1,1,1],[0,1,0]],  // rotation 2
    [[0,1,0],[1,1,0],[0,1,0]]   // rotation 3
  ]
}
```

Include SRS wall kick data:
- JLSTZ kicks (5 offsets per rotation transition)
- I piece kicks (different offsets)

Export: PIECES object, WALL_KICKS object
</task>

<task id="2">
Add collision detection to js/board.js.

Implement:
- isValidPosition(board, piece, x, y, rotation) function
  - Check if piece at position is within bounds
  - Check if piece overlaps any filled cells
  - Return true/false
</task>

<task id="3">
Create js/input.js for keyboard handling.

Implement:
- keys object tracking pressed state
- keydown listener: set keys[code] = true
- keyup listener: set keys[code] = false
- DAS (Delayed Auto Shift):
  - Initial delay: 170ms
  - Repeat rate: 50ms
- getInput() function returns current input state
- Export: setupInput, getInput
</task>

<task id="4">
Update js/render.js to draw current piece.

Add:
- drawPiece(piece, x, y, rotation) function
  - Get shape from PIECES[piece.type].shapes[rotation]
  - Draw each filled cell at correct position
  - Use piece color
</task>

<task id="5">
Update js/main.js with piece spawning and movement.

Implement:
- currentPiece state: { type, x, y, rotation }
- spawnPiece() function:
  - Random piece from 7-bag (shuffle all 7, deal, repeat)
  - Spawn at top center (x=3 or 4 depending on piece)
- movePiece(dx, dy) function:
  - Check if new position valid
  - Update position if valid
- rotatePiece() function:
  - Try rotation with wall kicks
  - Apply first valid kick offset
  - Do nothing if all kicks fail
- hardDrop() function:
  - Move piece down until collision
- processInput() function:
  - Read input state
  - Call appropriate move/rotate/drop functions
</task>

<task id="6">
Wire input processing into game loop.

Update main.js:
- Call setupInput() on init
- Call processInput() each frame
- Redraw piece after movement
</task>

## Verification

```
- [ ] All 7 piece types display correctly
- [ ] Left/right arrows move piece horizontally
- [ ] Down arrow accelerates fall (soft drop)
- [ ] Spacebar instantly drops piece to bottom
- [ ] Up arrow rotates piece clockwise
- [ ] Rotation works near walls (wall kicks)
- [ ] Pieces cannot move through walls or floor
- [ ] Pieces cannot overlap locked cells
```

## Must Haves

1. All 7 tetrominoes render with correct shapes and colors
2. Movement responds to arrow keys
3. Rotation works including wall kicks near edges
4. Hard drop (spacebar) works instantly
5. Pieces stop at board boundaries
