# Plan 01-03: Game Loop, Line Clearing & Game Over

---
wave: 3
depends_on: [01-02]
files_modified:
  - js/main.js
  - js/board.js
  - js/render.js
autonomous: true
---

## Objective

Implement the complete game loop with automatic piece falling, piece locking, line clearing, and game over detection.

## Requirements Addressed

- CORE-03: Pieces fall automatically at configurable speed
- CORE-09: Pieces lock when they land on surface/other pieces
- CORE-10: Completed rows clear and award points
- CORE-11: Game ends when pieces stack to top
- TECH-02: Game runs at 60fps using requestAnimationFrame

## Tasks

<task id="1">
Implement game loop with requestAnimationFrame in js/main.js.

Structure:
```javascript
let lastTime = 0;
let dropCounter = 0;
let dropInterval = 1000; // configurable speed (ms per row)

function gameLoop(timestamp) {
  const deltaTime = timestamp - lastTime;
  lastTime = timestamp;

  dropCounter += deltaTime;
  if (dropCounter > dropInterval) {
    dropPiece();
    dropCounter = 0;
  }

  processInput();
  render();
  requestAnimationFrame(gameLoop);
}
```

Start loop on DOMContentLoaded.
</task>

<task id="2">
Implement piece locking with lock delay in js/main.js.

When piece cannot move down:
- Start lock delay timer (500ms)
- If piece moves/rotates during delay, reset timer
- If timer expires, lock piece to board
- After locking, check for line clears, then spawn new piece
</task>

<task id="3">
Add lockPiece() function to js/board.js.

Implement:
- Takes current piece state
- Writes piece cells to board array with piece color
- Returns updated board
</task>

<task id="4">
Implement line clearing in js/board.js.

Add:
- checkLines(board) function:
  - Find all complete rows (no empty cells)
  - Return array of row indices
- clearLines(board, rows) function:
  - Remove complete rows
  - Shift rows above down
  - Add empty rows at top
  - Return { board: newBoard, linesCleared: count }
</task>

<task id="5">
Add line clear visual feedback in js/render.js.

Implement:
- Flash/highlight effect for cleared rows (brief white flash)
- Keep simple: just a 100ms highlight before removal
</task>

<task id="6">
Implement game over detection in js/main.js.

Check on piece spawn:
- If new piece immediately collides (isValidPosition returns false)
- Set gameOver = true
- Stop game loop
- Display "GAME OVER" text on canvas
</task>

<task id="7">
Add game over rendering in js/render.js.

Implement:
- drawGameOver() function
- Semi-transparent overlay
- "GAME OVER" text centered on canvas
- "Press R to restart" text below
</task>

<task id="8">
Add restart functionality in js/main.js.

Listen for 'R' key when game over:
- Reset board to empty
- Reset score (prepare for Phase 2)
- Spawn new piece
- Restart game loop
</task>

## Verification

```
- [ ] Pieces fall automatically at regular intervals
- [ ] Fall speed can be changed by modifying dropInterval
- [ ] Pieces lock after landing (with brief delay)
- [ ] Moving piece during lock delay resets the timer
- [ ] Complete rows are detected and cleared
- [ ] Rows above cleared lines fall down
- [ ] Multiple simultaneous line clears work
- [ ] Game ends when new piece cannot spawn
- [ ] Game over screen displays
- [ ] R key restarts the game
- [ ] Game runs smoothly at 60fps
```

## Must Haves

1. Automatic piece falling at configurable interval
2. Pieces lock on landing after brief delay
3. Complete rows clear and board shifts down
4. Game over triggers when board fills
5. Player can restart with R key
6. Smooth 60fps performance
