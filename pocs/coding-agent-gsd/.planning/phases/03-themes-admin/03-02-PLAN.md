---
phase: 03-themes-admin
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [js/render.js]
autonomous: true

must_haves:
  truths:
    - "Grid background uses currentTheme.colors.background"
    - "Grid lines use currentTheme.colors.grid"
    - "Sidebar uses currentTheme.colors.sidebar"
    - "Locked pieces on board render with theme color lookup"
    - "Active piece uses theme color"
    - "Ghost piece uses theme color"
    - "Theme change reflects immediately on next render frame"
  artifacts:
    - path: "js/render.js"
      provides: "Theme-aware canvas rendering"
      contains: "currentTheme.colors"
  key_links:
    - from: "js/render.js drawBoard"
      to: "currentTheme.colors"
      via: "color lookup by piece type"
      pattern: "currentTheme\\.colors\\[board\\[row\\]\\[col\\]\\]"
    - from: "js/render.js drawPiece"
      to: "currentTheme.colors"
      via: "color lookup by pieceType"
      pattern: "currentTheme\\.colors\\[pieceType\\]"
---

<objective>
Refactor render.js to use theme colors instead of hardcoded values.

Purpose: All canvas drawing uses currentTheme so changing theme instantly changes all visuals. Locked pieces must look up color by type from current theme.

Output: js/render.js with all hardcoded colors replaced by currentTheme.colors lookups.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-themes-admin/03-RESEARCH.md

@js/render.js
@js/themes.js (from 03-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor drawGrid to use theme colors</name>
  <files>js/render.js</files>
  <action>
In drawGrid function, replace hardcoded colors:

Current:
  ctx.fillStyle = '#0f0f1a';  (background)
  ctx.strokeStyle = '#2a2a4a';  (grid lines)

Change to:
  ctx.fillStyle = currentTheme.colors.background;
  ctx.strokeStyle = currentTheme.colors.grid;
  </action>
  <verify>drawGrid uses currentTheme.colors.background and currentTheme.colors.grid</verify>
  <done>No hardcoded hex colors in drawGrid function</done>
</task>

<task type="auto">
  <name>Task 2: Refactor drawBoard to look up piece type colors</name>
  <files>js/render.js</files>
  <action>
In drawBoard function, board cells now contain piece TYPE (like 'I', 'T') not color strings.

Current:
  if (board[row][col]) {
    ctx.fillStyle = board[row][col];

Change to look up color from current theme:
  if (board[row][col]) {
    ctx.fillStyle = currentTheme.colors[board[row][col]];

This enables locked pieces to change color when theme changes.
  </action>
  <verify>drawBoard uses currentTheme.colors[board[row][col]] for fillStyle</verify>
  <done>Locked pieces render using theme color lookup by type</done>
</task>

<task type="auto">
  <name>Task 3: Refactor remaining render functions to use theme</name>
  <files>js/render.js</files>
  <action>
Update all remaining functions that use colors:

drawPiece:
  Current: ctx.fillStyle = piece.color;
  Change: ctx.fillStyle = currentTheme.colors[pieceType];

drawSidebar:
  Current: ctx.fillStyle = '#16162a';
  Change: ctx.fillStyle = currentTheme.colors.sidebar;
  Also update strokeStyle for border: ctx.strokeStyle = currentTheme.colors.grid;

drawGhost:
  Current: ctx.fillStyle = piece.color;
  Change: ctx.fillStyle = currentTheme.colors[pieceType];

drawNextPreview:
  Current: ctx.fillStyle = piece.color;
  Change: ctx.fillStyle = currentTheme.colors[pieceType];

drawHoldPreview:
  Current: ctx.fillStyle = piece.color;
  Change: ctx.fillStyle = currentTheme.colors[pieceType];

Note: drawScore, drawGameOver, drawPaused, drawClearingLines can keep their current colors (white, red, etc.) as these are UI elements not themed pieces.
  </action>
  <verify>Search render.js for any remaining piece.color references - should be zero. Search for hardcoded sidebar color #16162a - should be zero.</verify>
  <done>All piece rendering and sidebar use theme colors. No piece.color references remain.</done>
</task>

</tasks>

<verification>
1. Open game in browser - should look identical (classic theme is same colors)
2. In console: applyTheme('neon') - grid should turn green, background black
3. Lock some pieces, then applyTheme('retro') - locked pieces should change to retro colors
4. Verify ghost piece and preview pieces also change with theme
</verification>

<success_criteria>
- drawGrid uses currentTheme.colors.background and currentTheme.colors.grid
- drawBoard looks up color by piece type from currentTheme
- drawPiece, drawGhost, drawNextPreview, drawHoldPreview use currentTheme.colors[pieceType]
- drawSidebar uses currentTheme.colors.sidebar
- No piece.color references in render.js
- Theme change via applyTheme() reflects immediately
</success_criteria>

<output>
After completion, create `.planning/phases/03-themes-admin/03-02-SUMMARY.md`
</output>
