---
phase: 03-themes-admin
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified: [admin.html, js/admin.js]
autonomous: true

must_haves:
  truths:
    - "Admin panel opens in separate browser tab"
    - "Theme selector changes game theme instantly"
    - "Speed slider changes piece fall rate"
    - "Points slider changes points per row"
    - "Growth interval slider changes board growth timing"
    - "Live stats display shows current score and level"
    - "Stats update every second"
    - "Game continues if admin tab closes"
  artifacts:
    - path: "admin.html"
      provides: "Admin panel HTML page"
      contains: "tetris-sync"
    - path: "js/admin.js"
      provides: "Admin panel controls and sync"
      contains: "BroadcastChannel"
  key_links:
    - from: "js/admin.js"
      to: "BroadcastChannel"
      via: "same channel name as game"
      pattern: "BroadcastChannel\\('tetris-sync'\\)"
    - from: "js/admin.js"
      to: "game tab"
      via: "postMessage"
      pattern: "channel\\.postMessage"
---

<objective>
Create admin panel HTML page with controls for theme, speed, scoring, and live stats display.

Purpose: Admin can control game in real-time from separate tab. This is the "admin tweaks, player experiences instantly" core value.

Output: admin.html page, js/admin.js with all controls and BroadcastChannel integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-themes-admin/03-RESEARCH.md

@js/sync.js (from 03-03)
@js/main.js (message handling from 03-03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin.html page structure</name>
  <files>admin.html</files>
  <action>
Create admin.html with:

1. Basic HTML5 structure
2. Title: "Tetris Twist - Admin Panel"
3. Inline styles (no external CSS) for simple dark theme matching game
4. Sections:
   - Header: "Admin Panel"
   - Theme selector: 3 radio buttons (Classic, Neon, Retro)
   - Speed control: Range slider (100ms to 2000ms, default 1000ms) with current value display
   - Points control: Range slider (1 to 50, default 10) with current value display
   - Growth interval: Range slider (10000ms to 120000ms, default 30000ms) with current value display
   - Live stats display: Score, Level, Current Theme, Game Status (playing/paused/game over)
5. Script tag loading js/admin.js at end of body

Style: Dark background (#16162a), white text, simple layout with labeled controls.
  </action>
  <verify>admin.html exists with theme radios, speed slider, points slider, growth slider, stats display</verify>
  <done>Admin panel page has all required controls and stats display areas</done>
</task>

<task type="auto">
  <name>Task 2: Create admin.js with BroadcastChannel controls</name>
  <files>js/admin.js</files>
  <action>
Create js/admin.js with:

1. Create BroadcastChannel:
   var channel = new BroadcastChannel('tetris-sync');

2. Theme selector change handler:
   var themeRadios = document.querySelectorAll('input[name="theme"]');
   themeRadios.forEach(function(radio) {
     radio.addEventListener('change', function() {
       channel.postMessage({
         type: 'THEME_CHANGE',
         payload: { themeName: radio.value }
       });
     });
   });

3. Speed slider change handler:
   var speedSlider = document.getElementById('speed-slider');
   var speedValue = document.getElementById('speed-value');
   speedSlider.addEventListener('input', function() {
     speedValue.textContent = speedSlider.value + 'ms';
     channel.postMessage({
       type: 'SPEED_CHANGE',
       payload: { dropInterval: parseInt(speedSlider.value) }
     });
   });

4. Points slider change handler (similar pattern)

5. Growth interval slider change handler (similar pattern)

6. Stats polling - request stats every second:
   setInterval(function() {
     channel.postMessage({ type: 'STATS_REQUEST', payload: {} });
   }, 1000);

7. Handle STATS_RESPONSE and THEME_CHANGE messages:
   channel.onmessage = function(event) {
     var data = event.data;
     if (data.type === 'STATS_RESPONSE') {
       document.getElementById('stat-score').textContent = data.payload.score;
       document.getElementById('stat-level').textContent = data.payload.level;
       document.getElementById('stat-theme').textContent = data.payload.theme;
       document.getElementById('stat-status').textContent =
         data.payload.gameOver ? 'Game Over' : (data.payload.paused ? 'Paused' : 'Playing');

       // Update theme radio to match game state
       var themeRadio = document.querySelector('input[name="theme"][value="' + data.payload.theme + '"]');
       if (themeRadio) themeRadio.checked = true;
     }
     else if (data.type === 'THEME_CHANGE') {
       var themeRadio = document.querySelector('input[name="theme"][value="' + data.payload.themeName + '"]');
       if (themeRadio) themeRadio.checked = true;
     }
   };

8. Cleanup on unload:
   window.addEventListener('beforeunload', function() {
     channel.close();
   });
  </action>
  <verify>js/admin.js sends THEME_CHANGE, SPEED_CHANGE, POINTS_CHANGE, GROWTH_INTERVAL_CHANGE messages. Handles STATS_RESPONSE.</verify>
  <done>Admin panel controls work, stats display updates, theme selector syncs with game state</done>
</task>

<task type="auto">
  <name>Task 3: Add admin panel launch button to game</name>
  <files>index.html</files>
  <action>
Add a small "Admin" button below the canvas in index.html that opens admin panel:

1. Add button element after canvas:
   <button id="admin-btn" style="margin-top: 10px; padding: 8px 16px; cursor: pointer;">Open Admin Panel</button>

2. Add inline script or modify to add click handler:
   document.getElementById('admin-btn').addEventListener('click', function() {
     window.open('admin.html', 'tetris-admin', 'width=400,height=600,resizable=yes');
   });

This satisfies ADMN-01: Admin panel in separate tab.
  </action>
  <verify>index.html has admin button that opens admin.html in new window</verify>
  <done>Game page has button to launch admin panel</done>
</task>

</tasks>

<verification>
1. Open game, click "Open Admin Panel" button - admin panel opens in new window
2. In admin panel, select "Neon" theme - game instantly changes to neon colors
3. Move speed slider to 200ms - pieces fall much faster
4. Move points slider to 50 - clear a row, score increases by 50
5. Admin panel shows current score and level updating live
6. Close admin panel - game continues working normally
7. Level up in game - admin panel theme selector updates to match
</verification>

<success_criteria>
- admin.html opens in separate tab
- Theme selector changes game theme instantly (ADMN-02, THEM-03)
- Speed slider changes fall speed (ADMN-03)
- Points slider changes points per row (ADMN-04)
- Growth interval slider exists (ADMN-05, used in Phase 4)
- Stats display shows score, level, theme, status (ADMN-06)
- All changes sync in real-time (ADMN-07)
- BroadcastChannel used (TECH-03)
- Game survives admin tab close
</success_criteria>

<output>
After completion, create `.planning/phases/03-themes-admin/03-04-SUMMARY.md`
</output>
